# Database Patterns

## Architecture

The app uses SQLite exclusively (Tauri-only, no web/PWA):
- **Database**: `src/lib/sqlite-db.ts` - SQLite via `@tauri-apps/plugin-sql`, always stored locally
- **API layer**: `src/lib/database.ts` - All CRUD functions, cache ops, raw SQL access
- **Sync engine**: `src/lib/sync-engine.ts` - Journal-based file sync (reads/writes JSON files to cloud-synced folder)
- **Sync API**: `src/lib/sync.ts` - Public sync API, status management, platform detection
- **Types**: `src/types/preferences.ts` - UserPreferences, ApiConfigRecord, etc.

## Critical: Database Location

The database is ALWAYS stored locally in the app data directory (`sqlite:biblemarker.db`). It is NEVER placed in a cloud-synced folder (e.g., iCloud Documents). Cloud sync is handled by the journal-based sync engine which writes small JSON files to a sync folder.

## Using the Database API

Always import from `@/lib/database` â€” never from `sqlite-db.ts` directly:

```typescript
import { 
  getChapterAnnotations, 
  saveAnnotation,
  getAllMarkingPresets,
  getPreferences,
  updatePreferences,
} from '@/lib/database';
```

All write operations automatically record changes in the `change_log` table for sync.

## Sync System

The sync system uses a file-based change journal:
1. Every write is logged to the `change_log` table
2. Periodically, changes are flushed to JSON files in the sync folder
3. Each device reads other devices' journal files and applies changes
4. Conflict resolution: newest-wins based on `updated_at`

Sync folder structure:
```
sync_folder/
  {device_id}/
    meta.json
    {seq}.json    # journal batch files
  snapshots/
    {device_id}_{seq}.json  # full DB snapshots
```

## Key Tables

| Table | Purpose | Synced |
|----|---|---|
| `annotations` | Highlights, symbols | Yes |
| `marking_presets` | Keyword definitions | Yes |
| `studies` | Study sessions | Yes |
| `preferences` | User settings | Yes |
| `change_log` | Pending sync changes | Local only |
| `sync_watermarks` | Per-device progress | Local only |
| `sync_config` | Sync settings | Local only |
| `chapter_cache` | Cached Bible text | Local only |

## Schema Migrations

Update the schema version and migration in `sqlite-db.ts`:

```typescript
const SCHEMA_VERSION = 3;  // Current version

async function migrateSchema(db, fromVersion, toVersion) {
  if (fromVersion < 3) {
    // Add new tables for v3...
  }
}
```
