---
description: Database patterns - SQLite via @tauri-apps/plugin-sql with iCloud sync
globs: "**/lib/validation.ts,**/lib/sqlite-db.ts,**/lib/database.ts,**/lib/sync.ts"
alwaysApply: false
---

# Database Patterns

## Architecture

The app uses SQLite exclusively (Tauri-only, no web/PWA):
- **Database**: `src/lib/sqlite-db.ts` - SQLite via `@tauri-apps/plugin-sql`
- **API layer**: `src/lib/database.ts` - All CRUD functions, cache ops, raw SQL access
- **Validation**: `src/lib/validation.ts` - Schema validation before writes
- **Sync**: `src/lib/sync.ts` - iCloud sync for Apple platforms
- **Types**: `src/types/preferences.ts` - UserPreferences, ApiConfigRecord, etc.

## Using the Database API

Always import from `@/lib/database` â€” never from `sqlite-db.ts` directly:

```typescript
import { 
  getChapterAnnotations, 
  saveAnnotation,
  getAllMarkingPresets,
  getPreferences,
  updatePreferences,
} from '@/lib/database';

const annotations = await getChapterAnnotations(moduleId, book, chapter);
await saveAnnotation(annotation);
```

## SQLite Schema Updates

Update the schema version and migration in `sqlite-db.ts`:

```typescript
const SCHEMA_VERSION = 2;

async function migrateSchema(db, fromVersion, toVersion) {
  if (fromVersion < 2) {
    await db.execute(`
      CREATE TABLE IF NOT EXISTS new_table (
        id TEXT PRIMARY KEY,
        data TEXT NOT NULL,
        ...
      )
    `);
  }
}
```

## Raw SQL Access

For queries not covered by the API layer:

```typescript
import { sqlSelect, sqlExecute } from '@/lib/database';

const rows = await sqlSelect<{ id: string; data: string }>(
  'SELECT id, data FROM annotations WHERE module_id = ?',
  [moduleId]
);
```

## Key Tables

| Table | Purpose | Key Indexes |
|-------|---------|-------------|
| `annotations` | Highlights, symbols | `module_id`, `type`, `preset_id` |
| `marking_presets` | Keyword definitions | `word`, `category` |
| `studies` | Study sessions | `id` |
| `chapter_cache` | Cached Bible text | `module_id` |
| `preferences` | User settings | `id` (singleton: 'main') |
| `backup_files` | Auto-backup metadata | `timestamp` |

## iCloud Sync (iOS/macOS)

```typescript
import { 
  checkICloudStatus, 
  getSyncStatus, 
  onSyncStatusChange 
} from '@/lib/sync';

const status = await checkICloudStatus();
if (status.available) {
  // iCloud container available at status.container_path
}
```
