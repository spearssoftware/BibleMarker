---
description: Database patterns - Dexie/IndexedDB (web) and SQLite (native) with iCloud sync
globs: "**/lib/db.ts,**/lib/validation.ts,**/lib/sqlite-db.ts,**/lib/database.ts,**/lib/sync.ts"
alwaysApply: false
---

# Database Patterns

## Architecture

The app uses a dual-database architecture:
- **Web**: Dexie (IndexedDB) - `src/lib/db.ts`
- **Native (iOS/macOS)**: SQLite - `src/lib/sqlite-db.ts`
- **Abstraction**: `src/lib/database.ts` - Unified interface
- **Validation**: `src/lib/validation.ts` - Schema validation before writes
- **Sync**: `src/lib/sync.ts` - iCloud sync for Apple platforms

## Platform Detection

```typescript
import { useSqlite } from '@/lib/database';

// Returns true on Tauri (native), false on web
if (useSqlite()) {
  // Using SQLite backend
} else {
  // Using IndexedDB (Dexie) backend
}
```

## Using the Unified API

Always use `src/lib/database.ts` for new code - it routes to the correct backend:

```typescript
import { 
  getChapterAnnotations, 
  saveAnnotation,
  getAllMarkingPresets,
} from '@/lib/database';

// Works on both web and native
const annotations = await getChapterAnnotations(moduleId, book, chapter);
await saveAnnotation(annotation);
```

## Dexie Schema Versioning (Web)

Add new tables by incrementing the version in `db.ts`:

```typescript
this.version(15).stores({
  // ... existing tables ...
  newTable: 'id, indexedField',
});
```

## SQLite Schema Updates (Native)

Update the schema version and migration in `sqlite-db.ts`:

```typescript
const SCHEMA_VERSION = 2;

async function migrateSchema(db, fromVersion, toVersion) {
  if (fromVersion < 2) {
    await db.execute(`
      CREATE TABLE IF NOT EXISTS new_table (
        id TEXT PRIMARY KEY,
        data TEXT NOT NULL,
        ...
      )
    `);
  }
}
```

## Validation Before Writes

Always validate data before saving (works with both backends):

```typescript
import { sanitizeData, ValidationError } from './validation';

export async function saveItem(item: Item): Promise<string> {
  try {
    const validated = sanitizeData(item, validateItem);
    // Use unified API
    return await saveToDatabase(validated);
  } catch (error) {
    if (error instanceof ValidationError) {
      throw new Error(`Invalid item: ${error.message}`);
    }
    throw error;
  }
}
```

## iCloud Sync (iOS/macOS)

The sync module handles iCloud integration:

```typescript
import { 
  checkICloudStatus, 
  getSyncStatus, 
  onSyncStatusChange 
} from '@/lib/sync';

// Check availability
const status = await checkICloudStatus();
if (status.available) {
  // iCloud container available at status.container_path
}

// Subscribe to status changes
const unsubscribe = onSyncStatusChange((status) => {
  console.log('Sync state:', status.state);
});
```

## Key Tables

| Table | Purpose | Key Indexes |
|-------|---------|-------------|
| `annotations` | Highlights, symbols | `moduleId`, `type`, `presetId` |
| `markingPresets` | Keyword definitions | `word`, `category` |
| `studies` | Study sessions | `id` |
| `chapterCache` | Cached Bible text | `moduleId` |
| `preferences` | User settings | `id` (singleton: 'main') |

## Data Migration

On first native app launch, existing IndexedDB data is migrated to SQLite:

```typescript
import { needsMigration, migrateIndexedDbToSqlite } from '@/lib/migration';

if (await needsMigration()) {
  const result = await migrateIndexedDbToSqlite();
  console.log(`Migrated ${result.recordCount} records`);
}
```
