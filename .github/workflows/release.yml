name: publish

on:
  workflow_dispatch:
  push:
    tags:
      - 'app-v*'

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.get-release-id.outputs.id }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
      - id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - name: Create draft release for tag
        run: |
          gh release create "app-v${{ steps.version.outputs.version }}" \
            --title "BibleMarker v${{ steps.version.outputs.version }}" \
            --notes-file RELEASE_NOTES.md \
            --draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - id: get-release-id
        run: echo "id=$(gh release view app-v${{ steps.version.outputs.version }} --json databaseId -q .databaseId)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-tauri:
    needs: prepare
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin
            tauri_target: aarch64-apple-darwin
          - platform: macos-latest
            args: --target x86_64-apple-darwin
            tauri_target: x86_64-apple-darwin
          - platform: ubuntu-22.04
            args: ""
            tauri_target: ""
          - platform: windows-latest
            args: ""
            tauri_target: ""
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "pnpm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        continue-on-error: true
        with:
          workspaces: "./src-tauri -> target"

      - name: Install frontend dependencies
        run: pnpm install

      - name: Generate icons
        run: pnpm tauri icon public/icon.svg

      # macOS only: import Apple Developer certificate for signing
      - name: Import Apple Developer Certificate
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode -o certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/pkgbuild -T /usr/bin/productbuild
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          echo "APPLE_SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep 'Developer ID Application' | head -1 | sed -E 's/.*\"([^\"]+)\".*/\1/')" >> $GITHUB_ENV

      # Build and upload (Linux/Windows): use existing release from prepare job
      - name: Build and release
        id: build
        if: matrix.platform != 'macos-latest'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.prepare.outputs.release_id }}
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # macOS: build only (no upload)
      - name: Build (macOS only)
        if: matrix.platform == 'macos-latest'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
        with:
          releaseDraft: true
          args: ${{ matrix.args }}

      # macOS only: re-sign with hardened runtime + timestamp for notarization
      - name: Re-sign for notarization
        if: matrix.platform == 'macos-latest'
        run: ./scripts/sign-macos.sh src-tauri/target/${{ matrix.tauri_target }}/release/bundle/macos

      # macOS only: notarize
      - name: Notarize app
        if: matrix.platform == 'macos-latest'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd src-tauri/target/${{ matrix.tauri_target }}/release/bundle/macos
          ditto -c -k --keepParent BibleMarker.app BibleMarker.zip
          xcrun notarytool submit BibleMarker.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --wait
          xcrun stapler staple BibleMarker.app
          ARCH=$([[ "${{ matrix.tauri_target }}" == *aarch64* ]] && echo "aarch64" || echo "x64")
          ditto -c -k --keepParent BibleMarker.app "$GITHUB_WORKSPACE/BibleMarker-macos-$ARCH.zip"

      # macOS only: upload stapled app to release (same tag updates existing release)
      - name: Upload macOS artifact to release
        if: matrix.platform == 'macos-latest'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-v${{ needs.prepare.outputs.version }}
          files: BibleMarker-macos-${{ matrix.tauri_target == 'aarch64-apple-darwin' && 'aarch64' || 'x64' }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    needs: prepare
    runs-on: macos-15
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode 26.2
        run: sudo xcode-select -s /Applications/Xcode_26.2.app

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "pnpm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        continue-on-error: true
        with:
          workspaces: "./src-tauri -> target"

      - name: Install frontend dependencies
        run: pnpm install

      - name: Generate icons
        run: pnpm tauri icon public/icon.svg

      - name: Set up App Store Connect API key
        env:
          API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$API_KEY" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Initialize iOS project
        run: pnpm tauri ios init
        env:
          CI: true

      - name: Raise iOS deployment target to 17.0
        run: sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = 14.0/IPHONEOS_DEPLOYMENT_TARGET = 17.0/g' src-tauri/gen/apple/biblemarker.xcodeproj/project.pbxproj

      - name: Build iOS app
        run: pnpm tauri ios build --export-method app-store-connect
        env:
          CI: true
          APPLE_DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_API_ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APPLE_API_KEY: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APPLE_API_KEY_PATH: ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: BibleMarker-iOS
          path: src-tauri/gen/apple/build/**/*.ipa
          if-no-files-found: warn

      - name: Upload to TestFlight
        env:
          API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          IPA_PATH=$(find src-tauri/gen/apple/build -name "*.ipa" | head -1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA found, skipping upload"
            exit 1
          fi
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$API_KEY_ID" \
            --apiIssuer "$API_ISSUER_ID"
